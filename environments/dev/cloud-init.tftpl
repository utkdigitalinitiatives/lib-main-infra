#cloud-config

# This cloud-init configuration is applied at VM boot time
# It sets up the database connection for the Drupal application

write_files:
  # Drupal database configuration file (included by environment.php)
  - path: /etc/drupal/settings.database.php
    permissions: '0640'
    owner: root:drupal
    content: |
      <?php
      /**
       * Database configuration for Drupal
       * Auto-generated by Terraform cloud-init for dev/test environment
       */
      $databases['default']['default'] = [
        'database' => '${db_name}',
        'username' => '${db_user}',
        'password' => '${db_password}',
        'host' => '${db_host}',
        'port' => '5432',
        'driver' => 'pgsql',
        'prefix' => '',
      ];

runcmd:
  # Ensure drupal group exists and has access to config directory
  - groupadd -f drupal
  - chown -R root:drupal /etc/drupal
  - chmod 750 /etc/drupal

  # Replace the getenv()-based database config in environment.php with require_once
  # The Packer image's environment.php uses getenv() which doesn't work with PHP-FPM
  - |
    if [ -f /etc/drupal/environment.php ]; then
      # Remove the existing database config block and replace with require_once
      sed -i '/^\$databases\[.default.\]\[.default.\] = \[/,/^\];$/c\// Database configuration loaded from cloud-init\nrequire_once "/etc/drupal/settings.database.php";' /etc/drupal/environment.php
      echo "Replaced database config with require_once" >> /var/log/cloud-init-output.log
    fi

  # Add IP address pattern to trusted hosts for dev/test access
  - |
    if [ -f /etc/drupal/environment.php ]; then
      # Add IP pattern to allow access via raw IP address
      sed -i "/^\\\$trusted_host_patterns = \[/a\  '^[0-9]+\\\\\.[0-9]+\\\\\.[0-9]+\\\\\.[0-9]+\$'," /etc/drupal/environment.php
      echo "Added IP address pattern to trusted_host_patterns" >> /var/log/cloud-init-output.log
    fi

  # Log that cloud-init completed
  - echo "Cloud-init database configuration complete" >> /var/log/cloud-init-output.log
