#cloud-config

# This cloud-init configuration is applied at VM boot time
# It sets up the database connection for the Drupal application
# Database has been synced from production by the CI/CD workflow

write_files:
  # Drupal database configuration file (included by environment.php)
  - path: /etc/drupal/settings.database.php
    permissions: '0640'
    owner: root:drupal
    content: |
      <?php
      /**
       * Database configuration for Drupal
       * Auto-generated by Terraform cloud-init for dev environment
       */
      $databases['default']['default'] = [
        'database' => '${db_name}',
        'username' => '${db_user}',
        'password' => '${db_password}',
        'host' => '${db_host}',
        'port' => '5432',
        'driver' => 'pgsql',
        'prefix' => '',
      ];

  # S3Proxy configuration for blob storage access
  - path: /etc/s3proxy/s3proxy.properties
    permissions: '0640'
    owner: root:s3proxy
    content: |
      jclouds.provider=azureblob
      jclouds.identity=${storage_account}
      jclouds.credential=${storage_key}
      jclouds.endpoint=https://${storage_account}.blob.core.windows.net
      s3proxy.authorization=none
      s3proxy.endpoint=http://127.0.0.1:8080

runcmd:
  # Ensure drupal group exists and has access to config directory
  - groupadd -f drupal
  - chown -R root:drupal /etc/drupal
  - chmod 750 /etc/drupal

  # Configure and start S3Proxy for blob storage
  - chown root:s3proxy /etc/s3proxy
  - chmod 750 /etc/s3proxy
  - chown root:s3proxy /etc/s3proxy/s3proxy.properties
  - systemctl enable s3proxy
  - systemctl start s3proxy
  - systemctl status s3proxy || true

  # Replace the getenv()-based database config in environment.php with require_once
  # The Packer image's environment.php uses getenv() which doesn't work with PHP-FPM
  - |
    if [ -f /etc/drupal/environment.php ]; then
      # Remove the existing database config block and replace with require_once
      sed -i '/^\$databases\[.default.\]\[.default.\] = \[/,/^\];$/c\// Database configuration loaded from cloud-init\nrequire_once "/etc/drupal/settings.database.php";' /etc/drupal/environment.php
      echo "Replaced database config with require_once" >> /var/log/cloud-init-output.log
    fi

  # Add IP address pattern to trusted hosts for dev/test access
  - |
    if [ -f /etc/drupal/environment.php ]; then
      # Add IP pattern to allow access via raw IP address
      sed -i "/^\\\$trusted_host_patterns = \[/a\  '^[0-9]+\\\\\.[0-9]+\\\\\.[0-9]+\\\\\.[0-9]+\$'," /etc/drupal/environment.php
      echo "Added IP address pattern to trusted_host_patterns" >> /var/log/cloud-init-output.log
    fi

  # Wait for database connection (sync may have just completed)
  - |
    DRUPAL_ROOT="/var/www/drupal"
    DRUSH="$DRUPAL_ROOT/vendor/bin/drush"
    cd "$DRUPAL_ROOT"
    echo "Waiting for database connection..." >> /var/log/cloud-init-output.log
    for i in $(seq 1 30); do
      if sudo -u drupal $DRUSH sql:query "SELECT 1" 2>/dev/null; then
        echo "Database connection established (attempt $i)" >> /var/log/cloud-init-output.log
        break
      fi
      echo "Waiting for database... (attempt $i/30)" >> /var/log/cloud-init-output.log
      sleep 10
    done

  # Apply pending database updates and rebuild caches
  - |
    DRUPAL_ROOT="/var/www/drupal"
    DRUSH="$DRUPAL_ROOT/vendor/bin/drush"
    cd "$DRUPAL_ROOT"
    echo "Running database updates..." >> /var/log/cloud-init-output.log
    sudo -u drupal $DRUSH updatedb -y >> /var/log/cloud-init-output.log 2>&1
    echo "Rebuilding caches..." >> /var/log/cloud-init-output.log
    sudo -u drupal $DRUSH cache:rebuild >> /var/log/cloud-init-output.log 2>&1
    echo "Drupal update complete" >> /var/log/cloud-init-output.log

  # Restart web services after configuration
  - systemctl restart php-fpm
  - systemctl restart httpd

  # Log that cloud-init completed
  - echo "Cloud-init database configuration complete" >> /var/log/cloud-init-output.log
