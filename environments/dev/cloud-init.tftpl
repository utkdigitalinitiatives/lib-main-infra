#cloud-config
# Cloud-init configuration for lib-main Drupal dev VMs
# This configures database, storage, and initializes Drupal from synced DB

write_files:
  # Drupal environment configuration (PHP)
  - path: /etc/drupal/environment.php
    permissions: '0640'
    owner: root:drupal
    content: |
      <?php
      /**
       * Drupal environment configuration.
       * Populated by cloud-init at boot time.
       */

      // Database configuration
      $databases['default']['default'] = [
        'database' => '${db_name}',
        'username' => '${db_user}',
        'password' => '${db_password}',
        'host' => '${db_host}',
        'port' => '5432',
        'driver' => 'pgsql',
        'prefix' => '',
      ];

      // Hash salt for security
      $settings['hash_salt'] = '${hash_salt}';

      // Trusted host patterns (allow IP access for dev/test)
      $settings['trusted_host_patterns'] = [
        '^localhost$',
        '^127\.0\.0\.1$',
        '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$',
      ];

      // S3FS configuration for Azure Blob Storage via S3Proxy
      $config['s3fs.settings']['bucket'] = 'drupal-media';
      $config['s3fs.settings']['region'] = 'us-east-1';
      $config['s3fs.settings']['use_customhost'] = TRUE;
      $config['s3fs.settings']['hostname'] = 'localhost:8080';
      $config['s3fs.settings']['use_path_style_endpoint'] = TRUE;
      $config['s3fs.settings']['use_https'] = FALSE;

      // S3FS credentials (not used with S3Proxy authorization=none)
      $settings['s3fs.access_key'] = 'unused';
      $settings['s3fs.secret_key'] = 'unused';

  # S3Proxy properties file
  - path: /etc/s3proxy/s3proxy.properties
    permissions: '0640'
    owner: root:s3proxy
    content: |
      # S3Proxy configuration for Azure Blob Storage
      jclouds.provider=azureblob
      jclouds.identity=${storage_account}
      jclouds.credential=${storage_key}
      jclouds.endpoint=https://${storage_account}.blob.core.windows.net
      s3proxy.authorization=none
      s3proxy.endpoint=http://127.0.0.1:8080

runcmd:
  # Ensure directories have correct ownership
  - chown root:drupal /etc/drupal
  - chmod 750 /etc/drupal
  - chown root:drupal /etc/drupal/environment.php

  - chown root:s3proxy /etc/s3proxy
  - chmod 750 /etc/s3proxy
  - chown root:s3proxy /etc/s3proxy/s3proxy.properties

  # Generate self-signed TLS certificate
  - |
    openssl req -x509 -nodes -days 30 \
      -newkey rsa:2048 \
      -keyout /etc/pki/tls/private/drupal-selfsigned.key \
      -out /etc/pki/tls/certs/drupal-selfsigned.crt \
      -subj "/CN=dev-vm/O=lib-main/OU=dev"
    chmod 600 /etc/pki/tls/private/drupal-selfsigned.key

  # Configure Apache HTTPS vhost
  - |
    cat > /etc/httpd/conf.d/ssl-selfsigned.conf <<'SSLCONF'
    Listen 443 https
    <VirtualHost *:443>
        SSLEngine on
        SSLCertificateFile /etc/pki/tls/certs/drupal-selfsigned.crt
        SSLCertificateKeyFile /etc/pki/tls/private/drupal-selfsigned.key

        DocumentRoot /var/www/drupal/web

        <Directory /var/www/drupal/web>
            Options -Indexes +FollowSymLinks
            AllowOverride All
            Require all granted
            RewriteEngine On
            RewriteBase /
            RewriteCond %%{REQUEST_FILENAME} !-f
            RewriteCond %%{REQUEST_FILENAME} !-d
            RewriteRule ^ index.php [L]
        </Directory>

        <FilesMatch \.php$>
            SetHandler "proxy:unix:/run/php-fpm/drupal.sock|fcgi://localhost"
        </FilesMatch>

        <Location /health>
            SetHandler none
            Require all granted
        </Location>

        Header always set X-Frame-Options "SAMEORIGIN"
        Header always set X-Content-Type-Options "nosniff"
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Strict-Transport-Security "max-age=300"

        ErrorLog /var/log/httpd/drupal-ssl-error.log
        CustomLog /var/log/httpd/drupal-ssl-access.log combined
        ProxyTimeout 300
    </VirtualHost>
    SSLCONF

  # Replace HTTP vhost with redirect to HTTPS (keep /health for probes)
  - |
    cat > /etc/httpd/conf.d/drupal.conf <<'REDIRECTCONF'
    <VirtualHost *:80>
        RewriteEngine On
        RewriteCond %%{REQUEST_URI} !^/health
        RewriteRule ^(.*)$ https://%%{HTTP_HOST}$1 [R=301,L]

        <Location /health>
            SetHandler none
            Require all granted
        </Location>
    </VirtualHost>
    REDIRECTCONF

  # Enable and start S3Proxy service
  - systemctl enable s3proxy
  - systemctl start s3proxy
  - systemctl status s3proxy || true

  # Wait for database connection (sync may have just completed)
  - |
    DRUPAL_ROOT="/var/www/drupal"
    DRUSH="$DRUPAL_ROOT/vendor/bin/drush"
    cd "$DRUPAL_ROOT"
    echo "Waiting for database connection..." >> /var/log/cloud-init-output.log
    for i in $(seq 1 30); do
      if sudo -u drupal $DRUSH sql:query "SELECT 1" 2>/dev/null; then
        echo "Database connection established (attempt $i)" >> /var/log/cloud-init-output.log
        break
      fi
      echo "Waiting for database... (attempt $i/30)" >> /var/log/cloud-init-output.log
      sleep 10
    done

  # Apply pending database updates, import config, and rebuild caches
  - |
    DRUPAL_ROOT="/var/www/drupal"
    DRUSH="$DRUPAL_ROOT/vendor/bin/drush"
    CONFIG_SYNC_DIR="$DRUPAL_ROOT/config"
    cd "$DRUPAL_ROOT"
    echo "Running database updates..." >> /var/log/cloud-init-output.log
    sudo -u drupal $DRUSH updatedb -y >> /var/log/cloud-init-output.log 2>&1
    # Import config if config directory has files
    if [ -f "$CONFIG_SYNC_DIR/system.site.yml" ]; then
      echo "Importing configuration..." >> /var/log/cloud-init-output.log
      sudo -u drupal $DRUSH config:import -y >> /var/log/cloud-init-output.log 2>&1 || {
        echo "Config import failed (may be no changes), continuing..." >> /var/log/cloud-init-output.log
      }
    else
      echo "No config in sync directory, skipping import" >> /var/log/cloud-init-output.log
    fi
    echo "Rebuilding caches..." >> /var/log/cloud-init-output.log
    sudo -u drupal $DRUSH cache:rebuild >> /var/log/cloud-init-output.log 2>&1
    echo "Drupal update complete" >> /var/log/cloud-init-output.log

  # Restart web services after configuration
  - systemctl restart php-fpm
  - systemctl restart httpd

  - echo "Cloud-init complete (dev environment)" >> /var/log/cloud-init-output.log
