name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      image_version:
        description: 'Image version to deploy (e.g., 1.4.0)'
        required: true
        type: string

env:
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  # Terraform variables (TF_VAR_ prefix)
  TF_VAR_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  TF_VAR_location: ${{ vars.LOCATION }}
  TF_VAR_use_gallery_image: "true"
  TF_VAR_gallery_name: ${{ vars.GALLERY_NAME }}
  TF_VAR_gallery_resource_group_name: ${{ vars.GALLERY_RESOURCE_GROUP }}
  TF_VAR_lb_dns_label: ${{ vars.LB_DNS_LABEL }}
  TF_VAR_admin_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
  TF_VAR_db_admin_password: ${{ secrets.DB_ADMIN_PASSWORD }}
  TF_VAR_enable_vmss_blob_access: "true"

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: environments/production
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ vars.TF_STATE_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ vars.TF_STATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=production/terraform.tfstate"

      - name: Terraform Plan
        working-directory: environments/production
        run: |
          terraform plan \
            -var="image_version=${{ github.event.inputs.image_version }}" \
            -out=tfplan

      - name: Terraform Apply (Rolling Update)
        working-directory: environments/production
        run: terraform apply -auto-approve tfplan

      - name: Get VMSS Details
        id: vmss
        working-directory: environments/production
        run: |
          echo "vmss_name=$(terraform output -raw vmss_name)" >> $GITHUB_OUTPUT
          echo "vmss_id=$(terraform output -raw vmss_id)" >> $GITHUB_OUTPUT
          echo "resource_group_name=$(terraform output -raw resource_group_name)" >> $GITHUB_OUTPUT
          echo "application_url=$(terraform output -raw application_url)" >> $GITHUB_OUTPUT

      - name: Monitor Rolling Update
        run: |
          echo "Monitoring rolling update for VMSS: ${{ steps.vmss.outputs.vmss_name }}"

          # Monitor upgrade status
          for i in {1..60}; do
            STATUS=$(az vmss get-instance-view \
              --name "${{ steps.vmss.outputs.vmss_name }}" \
              --resource-group "${{ steps.vmss.outputs.resource_group_name }}" \
              --query "statuses[?code=='ProvisioningState/succeeded'].code" \
              -o tsv 2>/dev/null || echo "pending")

            if [ "$STATUS" == "ProvisioningState/succeeded" ]; then
              echo "Rolling update completed successfully!"
              break
            fi

            echo "Update in progress... (check $i/60)"
            sleep 30
          done

      - name: Health Check
        run: |
          echo "Running health check..."
          APP_URL="${{ steps.vmss.outputs.application_url }}"

          for i in {1..10}; do
            if curl -sf "${APP_URL}/health" > /dev/null; then
              echo "Health check passed!"
              exit 0
            fi
            echo "Waiting for healthy response... (attempt $i/10)"
            sleep 30
          done

          echo "Warning: Health check did not pass within timeout"
          exit 1

      - name: Deployment Summary
        run: |
          echo "## Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image Version:** ${{ github.event.inputs.image_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**VMSS:** ${{ steps.vmss.outputs.vmss_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Application URL:** ${{ steps.vmss.outputs.application_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Rolling update completed. Verify the application at the URL above." >> $GITHUB_STEP_SUMMARY
