name: Cleanup PR Environment

on:
  repository_dispatch:
    types: [drupal-pr-closed]

env:
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  TF_VAR_admin_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
  TF_VAR_db_admin_password: ${{ secrets.DB_ADMIN_PASSWORD }}
  TF_VAR_gallery_name: ${{ vars.GALLERY_NAME }}
  TF_VAR_gallery_resource_group_name: ${{ vars.GALLERY_RESOURCE_GROUP }}
  TF_VAR_subnet_id: ${{ vars.SUBNET_ID }}
  TF_VAR_location: ${{ vars.LOCATION }}
  TF_VAR_devtest_db_host: ${{ vars.DEVTEST_DB_HOST }}
  TF_VAR_devtest_storage_account: ${{ vars.DEVTEST_STORAGE_ACCOUNT }}

jobs:
  cleanup:
    name: Cleanup PR Resources
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      # Determine PR number (from PR event or dispatch payload)
      - name: Get PR Number
        id: pr_number
        run: |
          if [ -n "${{ github.event.pull_request.number }}" ]; then
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ github.event.client_payload.pr_number }}" ]; then
            echo "pr_number=${{ github.event.client_payload.pr_number }}" >> $GITHUB_OUTPUT
          else
            echo "::error::No PR number found in event"
            exit 1
          fi

      # Use 'latest' as image version for destroy (required by data source validation)
      - name: Set placeholder variables
        run: |
          echo "TF_VAR_image_version=latest" >> $GITHUB_ENV

      - name: Azure CLI Login
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'

      - name: Get devtest storage key
        run: |
          KEY=$(az storage account keys list \
            --account-name "${{ vars.DEVTEST_STORAGE_ACCOUNT }}" \
            --resource-group lib-main-devtest-rg \
            --query "[0].value" -o tsv)
          echo "::add-mask::$KEY"
          echo "TF_VAR_devtest_storage_key=$KEY" >> $GITHUB_ENV

      # Destroy Test environment (if exists)
      - name: Destroy Test Environment
        working-directory: environments/test
        continue-on-error: true
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ vars.TF_STATE_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ vars.TF_STATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=test/pr-${{ steps.pr_number.outputs.pr_number }}/terraform.tfstate"
          terraform destroy -auto-approve -refresh=false \
            -var="pr_number=${{ steps.pr_number.outputs.pr_number }}" || true

      # Destroy Dev environment (VM + Resource Group)
      - name: Destroy Dev Environment
        working-directory: environments/dev
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ vars.TF_STATE_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ vars.TF_STATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=dev/pr-${{ steps.pr_number.outputs.pr_number }}/terraform.tfstate"
          terraform destroy -auto-approve -refresh=false \
            -var="pr_number=${{ steps.pr_number.outputs.pr_number }}"

      - name: Cleanup Summary
        run: |
          echo "## PR Environment Cleaned Up" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR Number:** ${{ steps.pr_number.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Resources Destroyed:**" >> $GITHUB_STEP_SUMMARY
          echo "- Dev Resource Group and VM" >> $GITHUB_STEP_SUMMARY
          echo "- Test Resource Group and VM" >> $GITHUB_STEP_SUMMARY
