name: Production Start/Stop Schedule

on:
  schedule:
    # 8:30 AM EST (9:30 AM EDT) — start resources (Mon–Fri)
    - cron: '30 13 * * 1-5'
    # 5:30 PM EST (6:30 PM EDT) — stop resources (Fri only; stays off Sat/Sun)
    - cron: '30 22 * * 5'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - start
          - stop

jobs:
  schedule:
    name: ${{ (github.event_name == 'workflow_dispatch' && inputs.action) || (github.event.schedule == '30 13 * * 1-5' && 'start') || 'stop' }} production
    runs-on: ubuntu-latest
    env:
      ACTION: ${{ (github.event_name == 'workflow_dispatch' && inputs.action) || (github.event.schedule == '30 13 * * 1-5' && 'start') || 'stop' }}
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'

      - name: Start PostgreSQL
        if: env.ACTION == 'start'
        run: |
          az postgres flexible-server start \
            --resource-group lib-main-production-rg \
            --name drupal-production-psql

      - name: Start VMSS
        if: env.ACTION == 'start'
        run: |
          az vmss start \
            --resource-group lib-main-production-rg \
            --name drupal-production-vmss \
            --instance-ids '*'

      - name: Stop VMSS
        if: env.ACTION == 'stop'
        run: |
          az vmss deallocate \
            --resource-group lib-main-production-rg \
            --name drupal-production-vmss \
            --instance-ids '*'

      - name: Stop PostgreSQL
        if: env.ACTION == 'stop'
        run: |
          az postgres flexible-server stop \
            --resource-group lib-main-production-rg \
            --name drupal-production-psql
