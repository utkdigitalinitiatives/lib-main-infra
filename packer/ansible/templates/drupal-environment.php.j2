<?php

/**
 * @file
 * Drupal environment configuration.
 *
 * This file is populated by cloud-init at boot time with environment-specific
 * settings including database credentials, S3FS configuration, and trusted hosts.
 *
 * DO NOT EDIT THIS FILE DIRECTLY - it will be overwritten on next boot.
 * To make changes, update the cloud-init configuration in Terraform.
 */

/**
 * Database configuration.
 * Values are injected by cloud-init from Terraform outputs.
 */
$databases['default']['default'] = [
  'database' => getenv('DRUPAL_DB_NAME') ?: 'drupal',
  'username' => getenv('DRUPAL_DB_USER') ?: 'drupaladmin',
  'password' => getenv('DRUPAL_DB_PASS') ?: '',
  'host' => getenv('DRUPAL_DB_HOST') ?: 'localhost',
  'port' => getenv('DRUPAL_DB_PORT') ?: '5432',
  'driver' => 'pgsql',
  'prefix' => '',
  'collation' => 'utf8mb4_general_ci',
];

/**
 * Hash salt for security.
 * Generated by cloud-init on first boot if not provided.
 */
$hash_salt = getenv('DRUPAL_HASH_SALT') ?: '{{ ansible_date_time.iso8601_micro | hash("sha256") }}';

/**
 * Trusted host patterns.
 * Production domains are added via cloud-init DRUPAL_TRUSTED_HOSTS environment variable.
 */
$trusted_host_patterns = [
  '^localhost$',
  '^127\.0\.0\.1$',
  // Production domains added via cloud-init
];

// Load additional trusted hosts from environment
$extra_hosts = getenv('DRUPAL_TRUSTED_HOSTS');
if ($extra_hosts) {
  $trusted_host_patterns = array_merge(
    $trusted_host_patterns,
    explode(',', $extra_hosts)
  );
}

/**
 * S3FS configuration for Azure Blob Storage via S3Proxy.
 */
$config['s3fs.settings']['bucket'] = getenv('S3FS_BUCKET') ?: 'drupal-media';
$config['s3fs.settings']['region'] = 'us-east-1'; // Required but ignored by S3Proxy
$config['s3fs.settings']['use_customhost'] = TRUE;
$config['s3fs.settings']['hostname'] = getenv('S3FS_HOSTNAME') ?: 'localhost:8080';
$config['s3fs.settings']['use_path_style_endpoint'] = TRUE;
$config['s3fs.settings']['use_https'] = FALSE; // S3Proxy on localhost
$config['s3fs.settings']['use_s3_signature_v2'] = TRUE; // S3Proxy requires v2

// S3FS credentials (not used with S3Proxy authorization=none, but required by module)
$settings['s3fs.access_key'] = getenv('S3FS_ACCESS_KEY') ?: 'unused';
$settings['s3fs.secret_key'] = getenv('S3FS_SECRET_KEY') ?: 'unused';

/**
 * Environment indicator.
 */
$settings['environment_indicator.current_release'] = getenv('DRUPAL_RELEASE_VERSION') ?: '{{ drupal_version }}';

/**
 * Performance settings for production.
 */
if (getenv('DRUPAL_ENV') === 'production') {
  // Disable development modules
  $config['system.performance']['css']['preprocess'] = TRUE;
  $config['system.performance']['js']['preprocess'] = TRUE;

  // Aggressive caching
  $config['system.performance']['cache']['page']['max_age'] = 900;
}

/**
 * Reverse proxy settings for Azure Load Balancer.
 */
$settings['reverse_proxy'] = TRUE;
$settings['reverse_proxy_addresses'] = ['127.0.0.1'];
$settings['reverse_proxy_trusted_headers'] =
  \Symfony\Component\HttpFoundation\Request::HEADER_X_FORWARDED_FOR |
  \Symfony\Component\HttpFoundation\Request::HEADER_X_FORWARDED_HOST |
  \Symfony\Component\HttpFoundation\Request::HEADER_X_FORWARDED_PORT |
  \Symfony\Component\HttpFoundation\Request::HEADER_X_FORWARDED_PROTO;
