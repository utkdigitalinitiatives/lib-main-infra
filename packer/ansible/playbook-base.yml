---
# Base Image Playbook
# This playbook configures system-level dependencies for Drupal.
# It is run monthly to create the base image that app builds inherit from.
# Time-consuming tasks (dnf update, package installation) happen here.

- name: Configure base system for Drupal application server
  hosts: all
  become: true

  vars:
    php_version: "{{ php_version | default('8.3') }}"
    drupal_user: "drupal"
    drupal_group: "drupal"
    web_root: "/var/www/drupal"
    s3proxy_version: "2.6.0"
    s3proxy_user: "s3proxy"
    s3proxy_group: "s3proxy"
    s3proxy_home: "/opt/s3proxy"

  tasks:
    # ==========================================================================
    # System updates and repositories (the big time-saver: ~5 min)
    # ==========================================================================
    - name: Update all packages
      ansible.builtin.dnf:
        name: "*"
        state: latest
        update_cache: true

    - name: Install EPEL repository
      ansible.builtin.dnf:
        name: epel-release
        state: present

    - name: Install Remi repository
      ansible.builtin.dnf:
        name: "https://rpms.remirepo.net/enterprise/remi-release-9.rpm"
        state: present
        disable_gpg_check: true

    - name: Reset PHP module
      ansible.builtin.command: dnf module reset php -y
      changed_when: true

    - name: Enable PHP {{ php_version }} module from Remi
      ansible.builtin.command: "dnf module enable php:remi-{{ php_version }} -y"
      changed_when: true

    # ==========================================================================
    # Package installation
    # ==========================================================================
    - name: Install required packages
      ansible.builtin.dnf:
        name:
          # Web server
          - httpd
          - mod_ssl
          # PHP and extensions
          - php
          - php-fpm
          - php-cli
          - php-common
          - php-pdo
          - php-pgsql
          - php-mysqlnd
          - php-gd
          - php-mbstring
          - php-xml
          - php-json
          - php-opcache
          - php-curl
          - php-zip
          - php-intl
          - php-bcmath
          - php-soap
          # Development tools
          - git
          - unzip
          - patch
          # Database client
          - postgresql
          # Utilities
          - vim-enhanced
          - htop
          - curl
          - wget
          # Java for S3Proxy
          - java-11-openjdk-headless
          # SELinux tools
          - policycoreutils-python-utils
          - setools-console
          # Firewall
          - firewalld
        state: present

    # ==========================================================================
    # Composer installation
    # ==========================================================================
    - name: Download Composer installer
      ansible.builtin.get_url:
        url: https://getcomposer.org/installer
        dest: /tmp/composer-setup.php
        mode: "0644"

    - name: Install Composer globally
      ansible.builtin.command: php /tmp/composer-setup.php --install-dir=/usr/local/bin --filename=composer
      args:
        creates: /usr/local/bin/composer

    - name: Remove Composer installer
      ansible.builtin.file:
        path: /tmp/composer-setup.php
        state: absent

    # ==========================================================================
    # User and group creation
    # ==========================================================================
    - name: Create drupal group
      ansible.builtin.group:
        name: "{{ drupal_group }}"
        system: true
        state: present

    - name: Create drupal user
      ansible.builtin.user:
        name: "{{ drupal_user }}"
        group: "{{ drupal_group }}"
        groups: apache
        create_home: true
        home: "/home/{{ drupal_user }}"
        shell: /bin/bash
        system: true
        state: present

    - name: Add apache user to drupal group
      ansible.builtin.user:
        name: apache
        groups: "{{ drupal_group }}"
        append: true

    # ==========================================================================
    # Directory structure
    # ==========================================================================
    - name: Create web root directory
      ansible.builtin.file:
        path: "{{ web_root }}"
        state: directory
        owner: "{{ drupal_user }}"
        group: "{{ drupal_group }}"
        mode: "0755"

    - name: Create Drupal config directory
      ansible.builtin.file:
        path: /etc/drupal
        state: directory
        owner: root
        group: "{{ drupal_group }}"
        mode: "0750"

    # ==========================================================================
    # PHP-FPM configuration
    # ==========================================================================
    - name: Configure PHP-FPM pool for Drupal
      ansible.builtin.template:
        src: templates/php-fpm-drupal.conf.j2
        dest: /etc/php-fpm.d/drupal.conf
        mode: "0644"
      notify: restart php-fpm

    - name: Remove default PHP-FPM www pool
      ansible.builtin.file:
        path: /etc/php-fpm.d/www.conf
        state: absent
      notify: restart php-fpm

    - name: Configure PHP settings
      ansible.builtin.lineinfile:
        path: /etc/php.ini
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
      loop:
        - { regexp: "^memory_limit", line: "memory_limit = 256M" }
        - { regexp: "^upload_max_filesize", line: "upload_max_filesize = 64M" }
        - { regexp: "^post_max_size", line: "post_max_size = 64M" }
        - { regexp: "^max_execution_time", line: "max_execution_time = 300" }
        - { regexp: "^;?date.timezone", line: "date.timezone = UTC" }
      notify: restart php-fpm

    # ==========================================================================
    # Apache configuration
    # ==========================================================================
    - name: Configure Apache for Drupal
      ansible.builtin.template:
        src: templates/apache-drupal.conf.j2
        dest: /etc/httpd/conf.d/drupal.conf
        mode: "0644"
      notify: restart httpd

    - name: Remove default Apache welcome page
      ansible.builtin.file:
        path: /etc/httpd/conf.d/welcome.conf
        state: absent
      notify: restart httpd

    - name: Disable default SSL configuration
      ansible.builtin.file:
        path: /etc/httpd/conf.d/ssl.conf
        state: absent
      notify: restart httpd

    - name: Enable httpd service
      ansible.builtin.systemd:
        name: httpd
        enabled: true

    - name: Enable php-fpm service
      ansible.builtin.systemd:
        name: php-fpm
        enabled: true

    # ==========================================================================
    # S3Proxy installation
    # ==========================================================================
    - name: Create s3proxy group
      ansible.builtin.group:
        name: "{{ s3proxy_group }}"
        system: true
        state: present

    - name: Create s3proxy user
      ansible.builtin.user:
        name: "{{ s3proxy_user }}"
        group: "{{ s3proxy_group }}"
        create_home: false
        shell: /sbin/nologin
        system: true
        state: present

    - name: Create S3Proxy directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ s3proxy_user }}"
        group: "{{ s3proxy_group }}"
        mode: "0755"
      loop:
        - "{{ s3proxy_home }}"
        - "{{ s3proxy_home }}/data"
        - /etc/s3proxy

    - name: Download S3Proxy JAR
      ansible.builtin.get_url:
        url: "https://github.com/gaul/s3proxy/releases/download/s3proxy-{{ s3proxy_version }}/s3proxy"
        dest: "{{ s3proxy_home }}/s3proxy.jar"
        owner: "{{ s3proxy_user }}"
        group: "{{ s3proxy_group }}"
        mode: "0644"

    - name: Create S3Proxy systemd service
      ansible.builtin.template:
        src: templates/s3proxy.service.j2
        dest: /etc/systemd/system/s3proxy.service
        mode: "0644"
      notify: reload systemd

    - name: Create S3Proxy environment file placeholder
      ansible.builtin.copy:
        content: |
          # S3Proxy environment configuration
          # This file is populated by cloud-init at boot with storage account credentials
          # JCLOUDS_PROVIDER=azureblob
          # JCLOUDS_IDENTITY=<storage_account_name>
          # JCLOUDS_CREDENTIAL=<storage_account_key>
          # JCLOUDS_ENDPOINT=https://<storage_account_name>.blob.core.windows.net
          # S3PROXY_AUTHORIZATION=none
        dest: /etc/s3proxy/s3proxy.env
        owner: root
        group: "{{ s3proxy_group }}"
        mode: "0640"

    - name: Enable s3proxy service
      ansible.builtin.systemd:
        name: s3proxy
        enabled: true
        daemon_reload: true

    # ==========================================================================
    # Firewall configuration
    # ==========================================================================
    - name: Enable firewalld
      ansible.builtin.systemd:
        name: firewalld
        enabled: true
        state: started

    - name: Open HTTP port
      ansible.posix.firewalld:
        port: 80/tcp
        permanent: true
        state: enabled
        immediate: true

    - name: Open HTTPS port
      ansible.posix.firewalld:
        port: 443/tcp
        permanent: true
        state: enabled
        immediate: true

    # ==========================================================================
    # SELinux configuration
    # ==========================================================================
    - name: Set SELinux context for web root
      community.general.sefcontext:
        target: "{{ web_root }}(/.*)?"
        setype: httpd_sys_rw_content_t
        state: present

    - name: Apply SELinux context
      ansible.builtin.command: "restorecon -Rv {{ web_root }}"
      changed_when: true

    - name: Allow httpd to connect to network
      ansible.posix.seboolean:
        name: httpd_can_network_connect
        state: true
        persistent: true

    - name: Allow httpd to connect to database
      ansible.posix.seboolean:
        name: httpd_can_network_connect_db
        state: true
        persistent: true

  handlers:
    - name: restart php-fpm
      ansible.builtin.systemd:
        name: php-fpm
        state: restarted

    - name: restart httpd
      ansible.builtin.systemd:
        name: httpd
        state: restarted

    - name: reload systemd
      ansible.builtin.systemd:
        daemon_reload: true
